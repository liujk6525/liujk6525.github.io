{
    "version": "https://jsonfeed.org/version/1",
    "title": "你不是单打独斗 • All posts by \"ssd.pytorch\" tag",
    "description": "",
    "home_page_url": "https://liujk6525.github.io",
    "items": [
        {
            "id": "https://liujk6525.github.io/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/%E8%B7%91%E9%80%9Assd-pytorch/",
            "url": "https://liujk6525.github.io/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/%E8%B7%91%E9%80%9Assd-pytorch/",
            "title": "跑通ssd.pytorch",
            "date_published": "2023-05-31T02:16:02.000Z",
            "content_html": "<p><strong>补：</strong></p>\r\n<h1 id=\"expected-a-cuda-device-type-for-generator-but-found-cpu\">Expected a ‘cuda‘ device type for generator but found ‘cpu‘</h1>\r\n<p>后来我在服务器训练的时候，发现出bug了。原来是<code>Pytorch</code>版本的原因，我在<code>faster-rcnn-pytorch</code>这个项目跑的，里面有现成的VOC数据集。但是这个环境<code>Pytorch</code>是1.9。</p>\r\n<ol type=\"1\">\r\n<li><p>修改<code>/root/miniconda3/lib/python3.7/site-packages/torch/utils/data/sampler.py</code>中代码，修改结果如下。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">generator = torch.Generator(device=<span class=\"string\">&#x27;cuda&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">yield</span> <span class=\"keyword\">from</span> torch.randperm(n, generator=generator, device=<span class=\"string\">&#x27;cuda&#x27;</span>).tolist()</span><br></pre></td></tr></table></figure>\r\n<span id=\"more\"></span></li>\r\n<li><p>修改<code>train.py</code>中代码，修改结果如下。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">data_loader = data.DataLoader(dataset, args.batch_size,</span><br><span class=\"line\">                                  num_workers=args.num_workers,</span><br><span class=\"line\">                                  shuffle=<span class=\"literal\">True</span>, collate_fn=detection_collate,</span><br><span class=\"line\">                                  pin_memory=<span class=\"literal\">True</span>, generator=torch.Generator(device=<span class=\"string\">&#x27;cuda&#x27;</span>))</span><br></pre></td></tr></table></figure></li>\r\n</ol>\r\n<h1 id=\"w-pthreadpool-cpp.cc90-warningleaking-caffe2-thread-pool-after-fork.function-pthreadpool\">[W pthreadpool-cpp.cc:90] Warning:Leaking Caffe2 thread-pool after fork.(function pthreadpool)</h1>\r\n<p>线程撕裂，出现了警告，警告数量为设置的线程数量，如果把线程数改小一些，就不会有警告了，但是会影响运行速度。修改<code>train.py</code>中的代码，修改结果如下。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">data_loader = data.DataLoader(dataset, args.batch_size,</span><br><span class=\"line\">                                 num_workers=args.num_workers,</span><br><span class=\"line\">                                 shuffle=<span class=\"literal\">True</span>, collate_fn=detection_collate,</span><br><span class=\"line\">                                 pin_memory=<span class=\"literal\">False</span>,generator=torch.Generator(device=<span class=\"string\">&#x27;cuda&#x27;</span>))</span><br></pre></td></tr></table></figure>\r\n<hr />\r\n<p>然后我想在服务器上用<code>visdom</code>看训练结果图，bug出现了。</p>\r\n<h1 id=\"nameerror-name-viz-is-not-defined\">NameError: name ‘viz’ is not defined</h1>\r\n<p>修改<code>train.py</code>中的代码，修改结果如下。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> visdom</span><br><span class=\"line\"><span class=\"keyword\">global</span> viz</span><br><span class=\"line\">viz = visdom.Visdom()</span><br></pre></td></tr></table></figure>\r\n<h1 id=\"assertionerror-must-define-a-window-to-update\">AssertionError: Must define a window to update</h1>\r\n<p>修改<code>train.py</code>中的代码，修改结果如下。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> args.visdom <span class=\"keyword\">and</span> iteration != <span class=\"number\">0</span> <span class=\"keyword\">and</span> (iteration % epoch_size == <span class=\"number\">0</span>):</span><br><span class=\"line\">    epoch += <span class=\"number\">1</span></span><br><span class=\"line\">    update_vis_plot(epoch, loc_loss, conf_loss, epoch_plot, <span class=\"literal\">None</span>,</span><br></pre></td></tr></table></figure>\r\n<h1 id=\"legacy-autograd-function-with-non-static-forward-method-is-deprecated\">Legacy autograd function with non-static forward method is deprecated</h1>\r\n<p>原因是当前版本要求forward过程是静态的，所以需要将原代码进行修改。</p>\r\n<ol type=\"1\">\r\n<li><p>从<a href=\"https://github.com/sayakbanerjee1999/Single-Shot-Object-Detection-Updated/blob/master/detection.py\"><code>Single-Shot-Object-Detection-Updated</code></a>下载<code>detect.py</code>文件，并将其替换掉原来的<code>layers/functions/detection.py</code></p></li>\r\n<li><p>修改<code>ssd.py</code>中的代码，修改结果如下。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> phase == <span class=\"string\">&#x27;test&#x27;</span>:</span><br><span class=\"line\">        self.softmax = nn.Softmax(dim=-<span class=\"number\">1</span>)</span><br><span class=\"line\">        self.detect = Detect()</span><br></pre></td></tr></table></figure>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> self.phase == <span class=\"string\">&quot;test&quot;</span>:</span><br><span class=\"line\">        output = self.detect.apply(self.num_classes, <span class=\"number\">0</span>, <span class=\"number\">200</span>, <span class=\"number\">0.01</span>, <span class=\"number\">0.45</span>,</span><br><span class=\"line\">                                   loc.view(loc.size(<span class=\"number\">0</span>), -<span class=\"number\">1</span>, <span class=\"number\">4</span>),  <span class=\"comment\"># loc preds</span></span><br><span class=\"line\">                                   self.softmax(conf.view(-<span class=\"number\">1</span>, self.num_classes)),  <span class=\"comment\"># conf preds</span></span><br><span class=\"line\">                                   self.priors.<span class=\"built_in\">type</span>(<span class=\"built_in\">type</span>(x.data))  <span class=\"comment\"># default boxes</span></span><br><span class=\"line\">                                   )</span><br></pre></td></tr></table></figure></li>\r\n</ol>\r\n<h1 id=\"errno-2-no-such-file-or-directory-test.txt\">[Errno 2] No such file or directory: ‘test.txt’</h1>\r\n<p>修改<code>eval.py</code>中的代码，修改结果如下。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">imgsetpath = os.path.join(args.voc_root, <span class=\"string\">&#x27;VOC2007&#x27;</span>, <span class=\"string\">&#x27;ImageSets&#x27;</span>, <span class=\"string\">&#x27;Main&#x27;</span>, <span class=\"string\">&#x27;&#123;&#125;.txt&#x27;</span>)</span><br></pre></td></tr></table></figure>\r\n<hr />\r\n<p>做实验对比，所以需要跑通ssd，这里部署的pytroch版本，大佬项目<a href=\"https://github.com/amdegroot/ssd.pytorch\"><code>ssd.pytorch</code></a>，中间踩了不少坑，记录如下</p>\r\n<p>目标：ssd.pytorch</p>\r\n<p>环境：cuda 11.3 | pytorch 1.8.1</p>\r\n<h1 id=\"修改xml文件的绝对路径\">修改xml文件的绝对路径</h1>\r\n<p>这是在之前的电脑打的标签，所以VOC数据集里面的标注文件.xml里面的<code>&lt;path&gt;</code>值还是老路径，</p>\r\n<p><img src=\"/imgs/$%7Bfiilename%7D/image-20230531102209091.png\"  style=\"zoom: 67%;\" /></p>\r\n<p>这里我更改成新的路径。</p>\r\n<p><img src=\"/imgs/$%7Bfiilename%7D/image-20230531102832023.png\"  style=\"zoom: 65%;\" /></p>\r\n<h1 id=\"indexerrorinvalid-index-of-a-0-dim-tensor\">IndexError:invalid index of a 0-dim tensor…</h1>\r\n<p>修改<code>train.py</code>中代码，<code>.data[0]</code>写法不适用高版本的Pytorch，修改结果如下。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">loc_loss += loss_l.item()</span><br><span class=\"line\">conf_loss += loss_c.item()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> iteration % <span class=\"number\">10</span> == <span class=\"number\">0</span>:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;timer: %.4f sec.&#x27;</span> % (t1 - t0))</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;iter &#x27;</span> + <span class=\"built_in\">repr</span>(iteration) + <span class=\"string\">&#x27; || Loss: %.4f ||&#x27;</span> % (loss.item()), end=<span class=\"string\">&#x27; &#x27;</span>)</span><br></pre></td></tr></table></figure>\r\n<h1 id=\"stopinteration\">StopInteration…</h1>\r\n<p>修改<code>train.py</code>中代码，修改结果如下。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    images, targets = <span class=\"built_in\">next</span>(batch_iterator)</span><br><span class=\"line\"><span class=\"keyword\">except</span> StopIteration:</span><br><span class=\"line\">    batch_iterator = <span class=\"built_in\">iter</span>(data_loader)</span><br><span class=\"line\">    images, targets = <span class=\"built_in\">next</span>(batch_iterator)</span><br></pre></td></tr></table></figure>\r\n<h1 id=\"indexerror-the-shape-of-the-mask-14-8732-at-index-0does\">IndexError: The shape of the mask [14, 8732] at index 0does…</h1>\r\n<p>交换<code>layers/modules/multibox_loss.py</code>中代码位置，修改结果如下。</p>\r\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">loss_c = loss_c.view(num, -1)</span><br><span class=\"line\">loss_c[pos] = 0  # filter out pos boxes for now</span><br></pre></td></tr></table></figure>\r\n<h1 id=\"lossnan\">loss：NAN</h1>\r\n<p>如果lr设置过高，可能会导致训练过程中loss出现NAN的情况。它默认的参数是1e-3，我这里将学习率修改为1e-4。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parser.add_argument(<span class=\"string\">&#x27;--lr&#x27;</span>, <span class=\"string\">&#x27;--learning-rate&#x27;</span>, default=<span class=\"number\">1e-4</span>, <span class=\"built_in\">type</span>=<span class=\"built_in\">float</span>,</span><br></pre></td></tr></table></figure>\r\n<h1 id=\"警告\">警告</h1>\r\n<p><strong>UserWarning: size_average and reduce args will be deprecated, please use reduction=‘sum’ instead. warnings.warn(warning.format(ret))</strong></p>\r\n<p>在高版本的Pytorch中，<code>size_average</code>和<code>reduce</code>这两个参数都将不再支持，修改<code>multibox_loss.py</code>中代码，修改结果如下。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">loss_l = F.smooth_l1_loss(loc_p, loc_t, reduction=<span class=\"string\">&#x27;sum&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">loss_c = F.cross_entropy(conf_p, targets_weighted, reduction=<span class=\"string\">&#x27;sum&#x27;</span>)</span><br></pre></td></tr></table></figure>\r\n<p><strong>UserWarning: volatile was removed and now has no effect. Use ‘with torch.no_grad():’ instead.</strong></p>\r\n<p>版本问题，修改<code>ssd.py</code>中代码，修改结果如下。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">with</span> torch.no_grad():</span><br><span class=\"line\">\tself.priors = Variable(self.priorbox.forward())</span><br></pre></td></tr></table></figure>\r\n<p><strong>UserWarning: nn.init.xavier_uniform is now deprecated in favor of nn.init.xavier_uniform_ .init.xavier_uniform(param)</strong></p>\r\n<p><code>nn.init.xavier_uniform</code>是以前的版本使用的，在高版本的Pytorch中已经被弃用。修改<code>train.py</code>中代码，修改结果如下。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">xavier</span>(<span class=\"params\">param</span>):</span><br><span class=\"line\">    init.xavier_uniform_(param)</span><br></pre></td></tr></table></figure>\r\n<p>可以发现很多警告就是版本不匹配的问题，但我是抱着只要能运行的心态，然而<code>UserWarning</code>又很影响观感，那就直接屏蔽它！</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> warnings</span><br><span class=\"line\"></span><br><span class=\"line\">warnings.filterwarnings(<span class=\"string\">&#x27;ignore&#x27;</span>)</span><br></pre></td></tr></table></figure>\r\n<p>或者命令行执行<code>xx.py</code>脚本文件</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python -W ignore xx.py</span><br></pre></td></tr></table></figure>\r\n<h1 id=\"运行train.py文件\">运行train.py文件</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python -W ignore train.py</span><br></pre></td></tr></table></figure>\r\n<p><img src=\"/imgs/$%7Bfiilename%7D/image-20230531115820400.png\" style=\"zoom: 67%;\" /></p>\r\n<h1 id=\"参考\">参考</h1>\r\n<p><a href=\"amdegroot/ssd.pytorch/issues/421\"><code>amdegroot/ssd.pytorch/issues/421</code></a></p>\r\n<p><a href=\"https://blog.csdn.net/qq_39506912/article/details/116926504?spm=1001.2014.3001.5506\"><code>SSD训练自己的数据集（pytorch版）</code></a></p>\r\n<p><a href=\"https://www.cnblogs.com/shaoxx333/p/16181651.html\"><code>Pytorch搭建SSD模型踩坑集锦</code></a></p>\r\n<p><a href=\"https://www.yii666.com/blog/407628.html\"><code>SSD训练数据集流程（学习记录）</code></a></p>\r\n",
            "tags": [
                "Python",
                "ssd.pytorch"
            ]
        }
    ]
}